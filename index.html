<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Choroid ¬∑ material time</title>
  <!-- Google Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0,1" rel="stylesheet" />
  
  <!-- PWA Manifest and Meta Tags -->
  <link rel="manifest" href="https://aditya-cmd-max.github.io/choroid/manifest.json">
  <meta name="theme-color" content="#ffb45b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Choroid">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  
  <style>
    /* Your existing CSS remains exactly the same */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Material 3 Dark theme */
      --md-sys-color-primary: #d3e3fd;
      --md-sys-color-on-primary: #001b3a;
      --md-sys-color-primary-container: #294978;
      --md-sys-color-on-primary-container: #d3e3fd;
      --md-sys-color-secondary: #c1d0e8;
      --md-sys-color-on-secondary: #2b3a4e;
      --md-sys-color-secondary-container: #41516b;
      --md-sys-color-on-secondary-container: #daeaff;
      --md-sys-color-tertiary: #f2c8d8;
      --md-sys-color-on-tertiary: #4b3540;
      --md-sys-color-tertiary-container: #674b57;
      --md-sys-color-on-tertiary-container: #ffe1f0;
      --md-sys-color-surface: #1e1f2b;
      --md-sys-color-surface-dim: #1e1f2b;
      --md-sys-color-surface-bright: #444653;
      --md-sys-color-on-surface: #e9edf5;
      --md-sys-color-surface-variant: #444e5c;
      --md-sys-color-on-surface-variant: #b9c2d1;
      --md-sys-color-background: #0b0e14;
      --md-sys-color-on-background: #e9edf5;
      --md-sys-color-outline: #8e95a2;
      --md-sys-color-outline-variant: #444e5c;
      --md-sys-color-shadow: #000000;
      --md-sys-color-inverse-surface: #e9edf5;
      --md-sys-color-inverse-on-surface: #1e1f2b;
      --md-sys-color-inverse-primary: #294978;
      
      /* Accent colors */
      --md-gold: #ffb45b;
      --md-cyan: #7ac4ff;
      --md-green: #8fde9f;
      --md-red: #ff9892;
      --md-purple: #c4a7ff;
      
      /* Elevation */
      --md-elevation-1: 0 2px 6px 2px rgba(0,0,0,0.15), 0 1px 2px 0 rgba(0,0,0,0.3);
      --md-elevation-2: 0 6px 12px 4px rgba(0,0,0,0.2), 0 2px 4px 0 rgba(0,0,0,0.3);
      --md-elevation-3: 0 12px 24px 8px rgba(0,0,0,0.25), 0 4px 8px 0 rgba(0,0,0,0.35);
      --md-elevation-4: 0 24px 48px 12px rgba(0,0,0,0.3), 0 8px 16px 0 rgba(0,0,0,0.4);
      
      /* Motion */
      --md-motion-spring: cubic-bezier(0.2, 0.9, 0.3, 1.2);
      --md-motion-emphasized: cubic-bezier(0.2, 0.0, 0, 1.0);
      --md-motion-emphasized-decelerate: cubic-bezier(0.05, 0.7, 0.1, 1.0);
      --md-motion-emphasized-accelerate: cubic-bezier(0.3, 0.0, 0.8, 0.15);
    }

    body {
      font-family: 'Google Sans', system-ui, -apple-system, sans-serif;
      background: var(--md-sys-color-background);
      color: var(--md-sys-color-on-background);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.3s var(--md-motion-emphasized-decelerate);
    }

    /* Canvas ambient */
    #stars-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      opacity: 0.3;
    }

    #app {
      position: relative;
      z-index: 2;
      max-width: 640px;
      margin: 0 auto;
      padding: 16px 20px 24px;
    }

    /* ========== IMPROVED CENTERED HEADER ========== */
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 8px 0 24px;
      animation: fadeSlideDown 0.5s var(--md-motion-emphasized-decelerate) both;
    }

    /* Top row with logo and settings */
    .header-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    /* Logo - hidden on mobile */
    .logo {
      width: 120px;
      height: auto;
      transition: transform 0.3s var(--md-motion-spring);
    }
    .logo:hover {
      transform: scale(1.03);
    }
    .logo img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Hide logo on mobile, center the settings icon */
    @media (max-width: 600px) {
      .logo {
        display: none;
      }
      .header-top-row {
        justify-content: center;
      }
    }

    /* Material 3 Settings Icon - centered on mobile */
    .settings-icon {
      font-size: 2rem;
      color: var(--md-sys-color-on-surface-variant);
      transition: all 0.3s var(--md-motion-spring);
      background: var(--md-sys-color-surface-dim);
      border-radius: 50%;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.05);
      cursor: pointer;
      box-shadow: var(--md-elevation-1);
    }
    .settings-icon:hover {
      transform: rotate(90deg) scale(1.1);
      background: var(--md-sys-color-surface-variant);
      color: var(--md-gold);
    }

    /* Centered time display */
    .header-time-center {
      font-family: 'Google Sans', monospace;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--md-gold);
      background: var(--md-sys-color-surface-dim);
      padding: 10px 24px;
      border-radius: 40px;
      border: 1px solid rgba(255,180,91,0.3);
      white-space: nowrap;
      box-shadow: 0 0 20px rgba(255,180,91,0.15);
      letter-spacing: 0.5px;
      width: fit-content;
      margin: 0 auto;
    }

    /* Material 3 Tabs - centered */
    .header-tabs {
      display: flex;
      gap: 8px;
      background: var(--md-sys-color-surface-dim);
      padding: 6px;
      border-radius: 32px;
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: var(--md-elevation-2);
      width: fit-content;
      margin: 0 auto;
    }

    .tab-btn {
      font-family: 'Google Sans', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      padding: 12px 32px;
      border-radius: 28px;
      border: none;
      background: transparent;
      color: var(--md-sys-color-on-surface-variant);
      transition: all 0.3s var(--md-motion-emphasized);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
    }
    .tab-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: currentColor;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .tab-btn:hover::before {
      opacity: 0.08;
    }
    .tab-btn:active {
      transform: scale(0.96);
    }
    .tab-btn.active {
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
      box-shadow: var(--md-elevation-1);
    }

    /* Mobile adjustments for tabs */
    @media (max-width: 480px) {
      .tab-btn {
        padding: 10px 24px;
        font-size: 0.95rem;
      }
      .header-time-center {
        font-size: 1.1rem;
        padding: 8px 20px;
      }
    }

    @keyframes fadeSlideDown {
      0% { opacity: 0; transform: translateY(-24px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .view {
      display: none;
      animation: fadeScale 0.4s var(--md-motion-emphasized-decelerate) both;
    }
    .view.active {
      display: block;
    }

    @keyframes fadeScale {
      0% { opacity: 0; transform: scale(0.96); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* Material 3 Clock Card */
    .clock-card {
      background: var(--md-sys-color-surface-dim);
      border-radius: 40px;
      padding: 28px 20px;
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: var(--md-elevation-3);
      backdrop-filter: blur(20px);
      margin-bottom: 24px;
      transition: transform 0.3s var(--md-motion-emphasized), box-shadow 0.3s;
    }

    .progress-ring-wrap {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      margin-bottom: 12px;
    }
    .progress-ring-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--md-gold);
      background: var(--md-sys-color-surface-variant);
      padding: 6px 16px;
      border-radius: 40px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .analog-container {
      display: flex;
      justify-content: center;
      margin: 0 auto 20px;
      width: 240px;
      height: 240px;
      margin-inline: auto;
    }
    #clockSvg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 12px 24px #00000080);
    }

    /* Material 3 Typography */
    .digital-time {
      font-family: 'Google Sans', sans-serif;
      font-size: 4rem;
      font-weight: 700;
      letter-spacing: -2px;
      line-height: 1.1;
      text-align: center;
      background: linear-gradient(135deg, #ffffff 0%, var(--md-gold) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }
    .digital-seconds {
      font-size: 1.4rem;
      color: var(--md-gold);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      opacity: 0.95;
    }
    .digital-date {
      font-size: 1.1rem;
      color: var(--md-sys-color-on-surface-variant);
      text-align: center;
      letter-spacing: 0.5px;
      margin: 16px 0 8px;
      font-weight: 500;
    }

    /* World Cities with Material 3 scroll */
    .world-cities {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 20px 0 12px;
      scrollbar-width: thin;
      scrollbar-color: var(--md-gold) var(--md-sys-color-surface-variant);
      -webkit-overflow-scrolling: touch;
    }
    .world-cities::-webkit-scrollbar {
      height: 4px;
    }
    .world-cities::-webkit-scrollbar-thumb {
      background: var(--md-gold);
      border-radius: 4px;
    }
    .city-chip {
      background: var(--md-sys-color-surface-variant);
      border-radius: 32px;
      padding: 14px 24px;
      flex: 0 0 auto;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.03);
      transition: all 0.3s var(--md-motion-spring);
      cursor: pointer;
    }
    .city-chip:hover {
      transform: translateY(-2px) scale(1.02);
      background: var(--md-sys-color-secondary-container);
    }
    .city-name {
      font-size: 0.9rem;
      color: var(--md-sys-color-on-surface-variant);
      margin-bottom: 4px;
    }
    .city-time {
      font-family: 'Google Sans', monospace;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--md-gold);
    }

    /* Material 3 Grid Cards */
    .side-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    @media (max-width: 480px) {
      .side-grid {
        grid-template-columns: 1fr;
      }
    }
    .side-card {
      background: var(--md-sys-color-surface-dim);
      border-radius: 32px;
      padding: 24px 16px;
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: var(--md-elevation-2);
      transition: all 0.3s var(--md-motion-emphasized);
    }
    .side-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--md-elevation-3);
    }
    .card-label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--md-gold);
      margin-bottom: 20px;
    }

    /* Stopwatch Display */
    .sw-display {
      font-family: 'Google Sans', monospace;
      font-size: 2.4rem;
      font-weight: 600;
      text-align: center;
      background: rgba(0,0,0,0.3);
      padding: 16px 8px;
      border-radius: 40px;
      margin-bottom: 16px;
    }
    .sw-ms {
      font-size: 1.4rem;
      color: var(--md-gold);
    }

    /* Material 3 Buttons */
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .btn {
      font-family: 'Google Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 40px;
      border: none;
      background: var(--md-sys-color-surface-variant);
      color: var(--md-sys-color-on-surface);
      transition: all 0.2s var(--md-motion-spring);
      border: 1px solid rgba(255,255,255,0.03);
      flex: 1 0 auto;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: currentColor;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .btn:hover::before {
      opacity: 0.08;
    }
    .btn:active {
      transform: scale(0.94);
    }
    .btn.primary {
      background: var(--md-gold);
      color: #1a1a1a;
    }
    .btn.danger {
      border-color: var(--md-red);
      color: var(--md-red);
      background: transparent;
    }
    .btn.success {
      border-color: var(--md-green);
      color: var(--md-green);
      background: transparent;
    }
    .btn.purple {
      border-color: var(--md-purple);
      color: var(--md-purple);
      background: transparent;
    }

    /* Laps list */
    .laps-list {
      max-height: 120px;
      overflow-y: auto;
      margin-top: 16px;
      font-size: 0.9rem;
      border-top: 1px solid rgba(255,255,255,0.05);
      padding-top: 12px;
      scrollbar-width: thin;
    }
    .lap-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      animation: slideInRight 0.3s;
      color: var(--md-sys-color-on-surface-variant);
    }

    /* Timer inputs */
    .timer-inputs {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      margin-bottom: 16px;
      transition: all 0.3s var(--md-motion-emphasized);
    }
    .timer-inputs.hidden {
      opacity: 0;
      transform: scale(0.8);
      pointer-events: none;
      position: absolute;
    }
    .timer-num {
      font-family: 'Google Sans', monospace;
      font-size: 1.8rem;
      font-weight: 600;
      background: var(--md-sys-color-surface-variant);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 24px;
      width: 70px;
      text-align: center;
      padding: 10px 0;
      color: white;
      transition: all 0.2s;
    }
    .timer-num:focus {
      outline: 2px solid var(--md-gold);
      transform: scale(1.05);
    }
    .timer-colon {
      font-size: 2rem;
      color: var(--md-sys-color-on-surface-variant);
    }
    .timer-display {
      font-family: 'Google Sans', monospace;
      font-size: 2.4rem;
      font-weight: 600;
      text-align: center;
      display: none;
      background: rgba(0,0,0,0.3);
      border-radius: 40px;
      padding: 16px;
    }
    .timer-display.visible {
      display: block;
      animation: scaleIn 0.4s var(--md-motion-emphasized-decelerate);
    }

    /* Material 3 Alarms */
    .alarms-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }
    .alarm-card {
      background: var(--md-sys-color-surface-dim);
      border-radius: 32px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: var(--md-elevation-2);
      transition: all 0.3s var(--md-motion-emphasized);
    }
    .alarm-card:hover {
      transform: translateX(4px);
      box-shadow: var(--md-elevation-3);
    }
    .alarm-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .alarm-time {
      font-size: 2.8rem;
      font-weight: 700;
      font-family: 'Google Sans', monospace;
      background: linear-gradient(135deg, #fff, var(--md-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .alarm-ampm {
      font-size: 1.4rem;
      color: var(--md-gold);
      margin-left: 8px;
    }

    /* Material 3 Toggle */
    .toggle {
      position: relative;
      width: 56px;
      height: 32px;
      cursor: pointer;
    }
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--md-sys-color-surface-variant);
      border-radius: 32px;
      transition: 0.3s var(--md-motion-emphasized);
    }
    .toggle-slider::before {
      content: '';
      width: 24px;
      height: 24px;
      background: #aaa;
      border-radius: 50%;
      position: absolute;
      top: 4px;
      left: 4px;
      transition: 0.3s var(--md-motion-spring);
    }
    .toggle input:checked + .toggle-slider {
      background: var(--md-gold);
    }
    .toggle input:checked + .toggle-slider::before {
      transform: translateX(24px);
      background: white;
    }

    .add-alarm-btn {
      background: var(--md-gold);
      border: none;
      padding: 16px 28px;
      border-radius: 60px;
      font-weight: 600;
      width: 100%;
      margin: 16px 0;
      color: #1a1a1a;
      cursor: pointer;
      transition: all 0.3s var(--md-motion-spring);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .add-alarm-btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
      box-shadow: var(--md-elevation-3);
    }

    /* Material 3 Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(24px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s var(--md-motion-emphasized);
    }
    .modal-overlay.open {
      opacity: 1;
      pointer-events: all;
    }
    .modal {
      background: var(--md-sys-color-surface-dim);
      border-radius: 48px;
      padding: 36px 28px;
      width: 90%;
      max-width: 420px;
      transform: scale(0.9) translateY(20px);
      transition: transform 0.4s var(--md-motion-spring);
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--md-elevation-4);
      border: 1px solid rgba(255,255,255,0.03);
    }
    .modal-overlay.open .modal {
      transform: scale(1) translateY(0);
    }

    /* Ringing overlay - IMPROVED FOR BETTER VISIBILITY */
    .ringing-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.98);
      backdrop-filter: blur(32px);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: 0.4s var(--md-motion-emphasized);
    }
    .ringing-overlay.open {
      opacity: 1;
      pointer-events: all;
    }
    .ringing-overlay > div:first-child {
      animation: ringBell 0.2s infinite alternate;
      font-size: 8rem;
      margin-bottom: 20px;
    }
    .ringing-overlay #ringTime {
      font-size: 5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #fff, var(--md-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 10px 0;
    }
    .ringing-overlay #ringLabel {
      font-size: 2.2rem;
      color: white;
      margin: 20px 0 30px;
    }
    .ringing-overlay .btn-row {
      max-width: 400px;
      width: 90%;
    }
    .ringing-overlay .btn {
      font-size: 1.2rem;
      padding: 16px 24px;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 24px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      pointer-events: none;
      z-index: 3000;
    }
    .toast {
      background: var(--md-sys-color-surface-dim);
      border-radius: 60px;
      padding: 14px 28px;
      font-weight: 500;
      box-shadow: var(--md-elevation-4);
      transform: translateY(100%);
      opacity: 0;
      transition: 0.3s var(--md-motion-spring);
      border: 1px solid var(--md-gold);
      backdrop-filter: blur(12px);
      color: white;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Waveform */
    #waveform {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      height: 36px;
      margin: 16px 0;
    }
    .wave-bar {
      width: 4px;
      background: linear-gradient(to top, var(--md-gold), var(--md-cyan));
      border-radius: 4px;
      transition: height 0.1s ease;
    }

    /* Settings items */
    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .settings-label {
      font-size: 1rem;
      font-weight: 500;
    }
    .select-clean {
      background: var(--md-sys-color-surface-variant);
      border: 1px solid rgba(255,255,255,0.05);
      padding: 10px 18px;
      border-radius: 40px;
      color: white;
      font-family: 'Google Sans', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-upload {
      background: var(--md-sys-color-surface-variant);
      padding: 10px 16px;
      border-radius: 40px;
      font-size: 0.9rem;
      color: var(--md-sys-color-on-surface-variant);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .btn.active {
      background: var(--md-gold);
      color: #1a1a1a;
      border-color: var(--md-gold);
    }

    @keyframes slideInRight {
      0% { opacity: 0; transform: translateX(20px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    @keyframes scaleIn {
      0% { opacity: 0; transform: scale(0.5); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes ringBell {
      0% { transform: rotate(-15deg) scale(1); }
      100% { transform: rotate(15deg) scale(1.2); }
    }

    /* Wake lock indicator */
    .wake-lock-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--md-gold);
      color: black;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      z-index: 100;
      display: none;
    }
    .wake-lock-indicator.active {
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="stars-canvas"></canvas>
  
  <!-- Wake lock indicator -->
  <div class="wake-lock-indicator" id="wakeLockIndicator">‚è∞ ACTIVE</div>

  <div id="app">
    <!-- ========== IMPROVED CENTERED HEADER ========== -->
    <header>
      <!-- Top row with logo (desktop) and settings (always visible) -->
      <div class="header-top-row">
        <div class="logo">
          <img src="https://i.ibb.co/tPzxM0JH/Choroid.png" alt="Choroid">
        </div>
        <span class="material-symbols-outlined settings-icon" id="settingsBtn">settings</span>
      </div>

      <!-- Centered time display -->
      <div class="header-time-center" id="headerTime">--:-- --</div>

      <!-- Centered tabs -->
      <div class="header-tabs">
        <button class="tab-btn active" data-view="clock">Clock</button>
        <button class="tab-btn" data-view="alarm">Alarms</button>
      </div>
    </header>

    <!-- CLOCK VIEW -->
    <div class="view active" id="view-clock">
      <div class="clock-card">
        <div class="progress-ring-wrap">
          <span class="progress-ring-label">DAY PROGRESS</span>
          <svg width="48" height="48" viewBox="0 0 48 48">
            <circle cx="24" cy="24" r="20" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="4"/>
            <circle id="dayRing" cx="24" cy="24" r="20" fill="none" stroke="url(#gradDay)" stroke-width="4" stroke-dasharray="125.6" stroke-dashoffset="125.6" transform="rotate(-90 24 24)"/>
            <defs><linearGradient id="gradDay"><stop offset="0%" stop-color="#ffb45b"/><stop offset="100%" stop-color="#7ac4ff"/></linearGradient></defs>
          </svg>
        </div>

        <div class="analog-container">
          <svg id="clockSvg" viewBox="0 0 280 280">
            <defs>
              <radialGradient id="faceGrad">
                <stop offset="0%" stop-color="#2a2c3b"/>
                <stop offset="100%" stop-color="#1e1f2b"/>
              </radialGradient>
            </defs>
            <circle cx="140" cy="140" r="134" fill="none" stroke="rgba(255,180,91,0.15)" stroke-width="2"/>
            <circle cx="140" cy="140" r="128" fill="url(#faceGrad)" stroke="rgba(255,180,91,0.1)" stroke-width="1"/>
            <g id="ticks"></g>
            <g id="hourNums"></g>
            <g id="hourHand" transform="rotate(0,140,140)">
              <rect x="137" y="70" width="6" height="85" rx="3" fill="#eef4ff"/>
            </g>
            <g id="minHand" transform="rotate(0,140,140)">
              <rect x="138.5" y="50" width="3" height="100" rx="1.5" fill="#ccddf8"/>
            </g>
            <g id="secHand" transform="rotate(0,140,140)">
              <line x1="140" y1="155" x2="140" y2="35" stroke="#ffb45b" stroke-width="2"/>
              <circle cx="140" cy="155" r="4" fill="#ffb45b"/>
            </g>
            <circle cx="140" cy="140" r="7" fill="#1e1f2b" stroke="#ffb45b" stroke-width="1.5"/>
            <circle cx="140" cy="140" r="3" fill="#ffb45b"/>
          </svg>
        </div>

        <div class="digital-time" id="digitalTime">12:00 AM</div>
        <div class="digital-seconds" id="digitalSeconds">:00 SEC</div>
        <div class="digital-date" id="digitalDate"></div>
        <div id="waveform"></div>

        <div class="world-cities" id="worldContainer"></div>
      </div>

      <div class="side-grid">
        <!-- stopwatch -->
        <div class="side-card">
          <div class="card-label">‚è± STOPWATCH</div>
          <div class="sw-display" id="swDisp">00:00<span class="sw-ms">.000</span></div>
          <div class="btn-row">
            <button class="btn primary" id="swStart">START</button>
            <button class="btn danger" id="swReset">RESET</button>
            <button class="btn purple" id="swLap">LAP</button>
          </div>
          <div class="laps-list" id="lapsList"></div>
        </div>
        <!-- timer -->
        <div class="side-card">
          <div class="card-label">‚è≤ TIMER</div>
          <div class="timer-inputs" id="timerInputs">
            <input type="number" class="timer-num" id="tH" min="0" value="0"><span class="timer-colon">:</span>
            <input type="number" class="timer-num" id="tM" min="0" value="5"><span class="timer-colon">:</span>
            <input type="number" class="timer-num" id="tS" min="0" value="0">
          </div>
          <div class="timer-display" id="timerDisp">00:05:00</div>
          <div class="btn-row">
            <button class="btn success" id="timerStart">START</button>
            <button class="btn danger" id="timerReset">RESET</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ALARM VIEW -->
    <div class="view" id="view-alarm">
      <button class="add-alarm-btn" id="openModalBtn">
        <span class="material-symbols-outlined">add_alarm</span>
        NEW ALARM
      </button>
      <div class="alarms-grid" id="alarmsGrid"></div>
    </div>
  </div>

  <!-- ALARM MODAL -->
  <div class="modal-overlay" id="alarmModal">
    <div class="modal">
      <h3 style="margin-bottom:24px; font-size:1.6rem;" id="modalTitle">New alarm</h3>
      <div style="display:flex; gap:12px; align-items:center; margin-bottom:24px;">
        <input type="number" class="timer-num" id="modalH" min="1" max="12" value="7" style="width:80px;"> <span style="font-size:2rem;">:</span>
        <input type="number" class="timer-num" id="modalM" min="0" max="59" value="0" style="width:80px;">
        <div style="display:flex; flex-direction:column; gap:6px;">
          <button class="btn" id="modalAm">AM</button>
          <button class="btn" id="modalPm">PM</button>
        </div>
      </div>
      <input type="text" id="modalLabel" placeholder="Label" style="width:100%; padding:16px; border-radius:60px; border:none; background:var(--md-sys-color-surface-variant); margin-bottom:20px; color:white; font-size:1rem;">
      
      <!-- Day selector -->
      <div style="margin-bottom:20px;">
        <div style="margin-bottom:12px; color:var(--md-gold);">Repeat</div>
        <div style="display:flex; flex-wrap:wrap; gap:8px;" id="daySelectorContainer"></div>
      </div>

      <!-- Sound selection -->
      <div style="margin-bottom:24px;">
        <div style="margin-bottom:12px; color:var(--md-gold);">Sound</div>
        <select id="alarmSoundSelect" class="select-clean" style="width:100%;">
          <option value="classic">Classic beep</option>
          <option value="digital">Digital</option>
          <option value="gentle">Gentle</option>
          <option value="uploaded">Uploaded tune</option>
        </select>
      </div>

      <div class="btn-row">
        <button class="btn" id="cancelModal">CANCEL</button>
        <button class="btn primary" id="saveAlarm">SAVE</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h3 style="margin-bottom:28px; display:flex; align-items:center; gap:12px; font-size:1.6rem;">
        <span class="material-symbols-outlined">settings</span> Settings
      </h3>
      
      <div class="settings-item">
        <span class="settings-label">Theme</span>
        <select id="themeSelect" class="select-clean">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>

      <div class="settings-item">
        <span class="settings-label">Default view</span>
        <select id="defaultViewSelect" class="select-clean">
          <option value="clock">Clock</option>
          <option value="alarm">Alarms</option>
        </select>
      </div>

      <div class="settings-item">
        <span class="settings-label">Timer auto‚Äëstart</span>
        <select id="timerAutoStart" class="select-clean">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>

      <div class="settings-item">
        <span class="settings-label">Vibration</span>
        <select id="vibrationSelect" class="select-clean">
          <option value="on">On</option>
          <option value="off">Off</option>
        </select>
      </div>

      <div class="settings-item">
        <span class="settings-label">Time format</span>
        <select id="hourFormat" class="select-clean">
          <option value="12">12h</option>
          <option value="24">24h</option>
        </select>
      </div>

      <div class="settings-item">
        <span class="settings-label">Default tune</span>
        <select id="defaultAlarmTune" class="select-clean">
          <option value="classic">Classic beep</option>
          <option value="digital">Digital</option>
          <option value="gentle">Gentle</option>
          <option value="uploaded">Uploaded</option>
        </select>
      </div>

      <div class="settings-item">
        <span class="settings-label">Upload custom</span>
        <input type="file" id="uploadTune" accept="audio/*" class="file-upload">
      </div>

      <div class="btn-row" style="margin-top:32px;">
        <button class="btn" id="closeSettings">CLOSE</button>
        <button class="btn primary" id="saveSettings">SAVE</button>
      </div>
    </div>
  </div>

  <!-- RINGING OVERLAY - Enhanced for better visibility -->
  <div class="ringing-overlay" id="ringingOverlay">
    <div>‚è∞</div>
    <div id="ringTime"></div>
    <div id="ringLabel"></div>
    <div class="btn-row">
      <button class="btn" id="snoozeBtn">SNOOZE 5m</button>
      <button class="btn danger" id="dismissBtn">DISMISS</button>
    </div>
  </div>

  <div class="toast-container" id="toast"></div>

  <script>
    (function() {
      // ========== ENHANCED ALARM SYSTEM WITH BACKGROUND SUPPORT ==========
      const DAYS = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
      
      // Load from localStorage
      let alarms = JSON.parse(localStorage.getItem('choroid_alarms_v2') || '[]');
      
      // Settings
      let settings = JSON.parse(localStorage.getItem('choroid_settings_v2') || JSON.stringify({
        theme: 'dark',
        defaultView: 'clock',
        timerAutoStart: 'off',
        vibration: 'on',
        hourFormat: '12',
        defaultTune: 'classic',
        uploadedTune: null,
        uploadedTuneName: null
      }));
      
      let activeRinging = null;
      let ringTimeout = null;
      let ringAudio = null;
      let snoozeTimeout = null;
      let editingId = null;
      let wakeLock = null;
      let audioContext = null;

      // Apply theme
      if (settings.theme === 'light') {
        document.body.classList.add('light-theme');
      }

      // ========== WAKE LOCK API - Keep screen on during alarm ==========
      async function requestWakeLock() {
        if ('wakeLock' in navigator) {
          try {
            wakeLock = await navigator.wakeLock.request('screen');
            document.getElementById('wakeLockIndicator').classList.add('active');
            console.log('Wake lock acquired');
            
            wakeLock.addEventListener('release', () => {
              document.getElementById('wakeLockIndicator').classList.remove('active');
              console.log('Wake lock released');
            });
          } catch (err) {
            console.error('Wake lock error:', err);
          }
        }
      }

      function releaseWakeLock() {
        if (wakeLock) {
          wakeLock.release();
          wakeLock = null;
        }
      }

      // ========== BACKGROUND AUDIO SETUP ==========
      function initAudioContext() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioContext;
      }

      async function playSoundInBackground(type) {
        try {
          // Stop any currently playing sound
          if (ringAudio) {
            ringAudio.pause();
            ringAudio.currentTime = 0;
            ringAudio = null;
          }

          // Try to use Web Audio API for better background support
          if (type === 'uploaded' && settings.uploadedTune) {
            // For uploaded tunes, use regular Audio element
            ringAudio = new Audio(settings.uploadedTune);
            ringAudio.volume = 0.3;
            ringAudio.loop = true; // Loop for continuous alarm
            
            // Try to play and handle autoplay restrictions
            try {
              await ringAudio.play();
            } catch (e) {
              console.log('Audio play failed, will retry after user interaction');
              // Show notification as fallback
              showNotification('‚è∞ Alarm!', ringAudio);
            }
            
            ringAudio.onended = () => { 
              if (ringAudio === ringAudio) ringAudio = null; 
            };
          } else {
            // Use Web Audio API for generated sounds (better background support)
            const ctx = initAudioContext();
            
            // Resume audio context if suspended
            if (ctx.state === 'suspended') {
              await ctx.resume();
            }
            
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            // Set sound type
            if (type === 'classic') {
              oscillator.frequency.value = 880;
              oscillator.type = 'sine';
            } else if (type === 'digital') {
              oscillator.frequency.value = 440;
              oscillator.type = 'square';
            } else if (type === 'gentle') {
              oscillator.frequency.value = 330;
              oscillator.type = 'triangle';
            }
            
            gainNode.gain.value = 0.15;
            
            // Loop the sound
            oscillator.start();
            
            // Store oscillator for stopping later
            ringAudio = {
              stop: () => {
                oscillator.stop();
                oscillator.disconnect();
              },
              oscillator,
              gainNode
            };
          }

          // Vibrate if enabled
          if (settings.vibration === 'on' && navigator.vibrate) {
            navigator.vibrate([500, 200, 500, 200, 500]);
          }

        } catch (e) {
          console.error('Audio playback error:', e);
          // Fallback to notification
          showNotification('‚è∞ Alarm!', null);
        }
      }

      function stopBackgroundSound() {
        if (ringAudio) {
          if (ringAudio.stop) {
            ringAudio.stop();
          } else {
            ringAudio.pause();
            ringAudio.currentTime = 0;
          }
          ringAudio = null;
        }
        
        // Suspend audio context to save battery
        if (audioContext && audioContext.state === 'running') {
          audioContext.suspend();
        }
      }

      // ========== NOTIFICATION SYSTEM ==========
      async function showNotification(title, alarm) {
        // Request permission if not granted
        if (Notification.permission !== 'granted') {
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') return;
        }

        // Show notification
        const notification = new Notification(title, {
          body: alarm ? `${alarm.time} ${alarm.ampm} - ${alarm.label || 'Alarm'}` : 'Time is up!',
          icon: 'icon-192x192.png',
          badge: 'icon-96x96.png',
          vibrate: [200, 100, 200],
          tag: 'alarm',
          renotify: true,
          requireInteraction: true, // Keep notification until user interacts
          actions: [
            { action: 'snooze', title: 'Snooze 5m' },
            { action: 'dismiss', title: 'Dismiss' }
          ]
        });

        notification.onclick = (event) => {
          event.preventDefault();
          window.focus();
          notification.close();
        };

        notification.onaction = (event) => {
          if (event.action === 'snoooze') {
            handleSnooze();
          } else if (event.action === 'dismiss') {
            handleDismiss();
          }
          notification.close();
        };
      }

      // ========== BACKGROUND TIMER WORKER ==========
      let timerWorker = null;
      
      function startBackgroundTimer(minutes) {
        // Use setTimeout for background timing
        const timeoutId = setTimeout(() => {
          // Timer finished in background
          playSoundInBackground(settings.defaultTune);
          showNotification('‚è∞ Timer Finished!', null);
          requestWakeLock();
          document.getElementById('ringingOverlay').classList.add('open');
        }, minutes * 60 * 1000);
        
        return timeoutId;
      }

      // ========== ENHANCED ALARM CHECKING ==========
      function checkAlarms(now) {
        if (activeRinging) return;
        
        let h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
        
        alarms.forEach(a => {
          if (!a.active) return;
          
          let [ah, am] = a.time.split(':').map(Number);
          if (a.ampm === 'PM' && ah !== 12) ah += 12;
          if (a.ampm === 'AM' && ah === 12) ah = 0;
          
          let today = DAYS[now.getDay()];
          if (a.days && a.days.length > 0 && !a.days.includes(today)) return;
          
          // Check with 30-second window for better reliability
          if (ah === h && am === m && s <= 30) {
            triggerAlarm(a);
          }
        });
      }

      // ========== TRIGGER ALARM WITH FULL SCREEN OVERLAY ==========
      async function triggerAlarm(alarm) {
        activeRinging = alarm;
        
        // Update overlay
        document.getElementById('ringTime').innerText = `${alarm.time} ${alarm.ampm}`;
        document.getElementById('ringLabel').innerText = alarm.label || 'Alarm';
        
        // Show overlay
        document.getElementById('ringingOverlay').classList.add('open');
        
        // Request wake lock to keep screen on
        await requestWakeLock();
        
        // Play sound
        const soundToPlay = alarm.sound || settings.defaultTune;
        await playSoundInBackground(soundToPlay);
        
        // Show notification as backup
        showNotification('‚è∞ Alarm!', alarm);
        
        // Schedule repeat
        if (ringTimeout) clearTimeout(ringTimeout);
        ringTimeout = setTimeout(() => {
          if (activeRinging === alarm) {
            playSoundInBackground(soundToPlay);
          }
        }, 10000); // Repeat every 10 seconds
      }

      // ========== HANDLE DISMISS ==========
      function handleDismiss() {
        stopBackgroundSound();
        releaseWakeLock();
        if (ringTimeout) clearTimeout(ringTimeout);
        if (snoozeTimeout) clearTimeout(snoozeTimeout);
        activeRinging = null;
        document.getElementById('ringingOverlay').classList.remove('open');
        showToast('Alarm dismissed');
      }

      // ========== HANDLE SNOOZE ==========
      function handleSnooze() {
        stopBackgroundSound();
        releaseWakeLock();
        
        let snoozeAlarm = activeRinging;
        document.getElementById('ringingOverlay').classList.remove('open');
        showToast('Snoozed 5 minutes');
        
        if (snoozeTimeout) clearTimeout(snoozeTimeout);
        snoozeTimeout = setTimeout(() => {
          if (snoozeAlarm) {
            triggerAlarm(snoozeAlarm);
          }
        }, 5 * 60 * 1000); // 5 minutes
        
        activeRinging = null;
      }

      // Attach handlers
      document.getElementById('dismissBtn').onclick = handleDismiss;
      document.getElementById('snoozeBtn').onclick = handleSnooze;

      // ========== SERVICE WORKER REGISTRATION ==========
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(reg => {
              console.log('Service Worker registered');
              
              // Listen for messages from service worker
              navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'ALARM_TRIGGER') {
                  const alarm = alarms.find(a => a.id === event.data.alarmId);
                  if (alarm) triggerAlarm(alarm);
                } else if (event.data.type === 'SNOOZE_ALARM') {
                  handleSnooze();
                } else if (event.data.type === 'DISMISS_ALARM') {
                  handleDismiss();
                }
              });
            })
            .catch(err => console.log('Service Worker error:', err));
        });
      }

      // ========== REQUEST NOTIFICATION PERMISSION ==========
      function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission !== 'granted') {
          Notification.requestPermission();
        }
      }

      // Call on user interaction
      document.addEventListener('click', () => {
        requestNotificationPermission();
      }, { once: true });

      // ========== VISIBILITY CHANGE HANDLER ==========
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // Page hidden - alarms will be handled by service worker
          console.log('App in background, alarms handled by service worker');
        } else {
          // Page visible again
          if (activeRinging) {
            document.getElementById('ringingOverlay').classList.add('open');
          }
        }
      });

      // ========== HELPER FUNCTIONS (keep your existing ones) ==========
      const fmt2 = n => String(n).padStart(2,'0');
      const fmt3 = n => String(n).padStart(3,'0');

      // Stars canvas (keep your existing implementation)
      const canvas = document.getElementById('stars-canvas');
      const ctx = canvas.getContext('2d');
      let stars = [];
      function initStars() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        stars = Array.from({length:100}, () => ({ 
          x: Math.random()*canvas.width, 
          y: Math.random()*canvas.height, 
          r: Math.random()*1.5, 
          speed: 0.003 + Math.random()*0.008, 
          phase: Math.random()*2*Math.PI 
        }));
      }
      function drawStars() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        stars.forEach(s => { 
          s.phase += s.speed; 
          let a = 0.2 + 0.2*Math.sin(s.phase); 
          ctx.fillStyle = `rgba(255,240,200,${a})`; 
          ctx.beginPath(); 
          ctx.arc(s.x,s.y,s.r,0,2*Math.PI); 
          ctx.fill(); 
        });
        requestAnimationFrame(drawStars);
      }
      window.addEventListener('resize', initStars);
      initStars();
      drawStars();

      // Build clock ticks (keep your existing implementation)
      const ticks = document.getElementById('ticks');
      const hourNums = document.getElementById('hourNums');
      for(let i=0;i<60;i++) {
        let angle = i/60*2*Math.PI - Math.PI/2;
        let isHour = i%5===0;
        let r1 = isHour?116:122, r2=isHour?128:126;
        let line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',140+r1*Math.cos(angle));
        line.setAttribute('y1',140+r1*Math.sin(angle));
        line.setAttribute('x2',140+r2*Math.cos(angle));
        line.setAttribute('y2',140+r2*Math.sin(angle));
        line.setAttribute('stroke', isHour?'#ffb45b':'#5a5f73');
        line.setAttribute('stroke-width', isHour?'2.5':'1.5');
        ticks.appendChild(line);
      }
      for(let i=1;i<=12;i++) {
        let angle = i/12*2*Math.PI - Math.PI/2; 
        let r=106;
        let txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x',140+r*Math.cos(angle));
        txt.setAttribute('y',140+r*Math.sin(angle)+4);
        txt.setAttribute('text-anchor','middle');
        txt.setAttribute('fill','#b9c2d1');
        txt.setAttribute('font-size','14');
        txt.textContent=i;
        hourNums.appendChild(txt);
      }

      // Cities
      const cities = [
        { name:'London', off:0, flag:'üá¨üáß' },
        { name:'New York', off:-5, flag:'üá∫üá∏' },
        { name:'Tokyo', off:9, flag:'üáØüáµ' },
        { name:'Sydney', off:11, flag:'üá¶üá∫' },
        { name:'Dubai', off:4, flag:'üá¶üá™' },
        { name:'Paris', off:1, flag:'üá´üá∑' }
      ];
      function renderCities() {
        let container = document.getElementById('worldContainer');
        container.innerHTML = '';
        cities.forEach(c => {
          let chip = document.createElement('div');
          chip.className = 'city-chip';
          chip.innerHTML = `<div class="city-name">${c.flag} ${c.name}</div><div class="city-time" data-off="${c.off}">--:--</div>`;
          container.appendChild(chip);
        });
      }
      renderCities();

      // Clock update
      function updateClock() {
        let now = new Date();
        let h = now.getHours(), m = now.getMinutes(), s = now.getSeconds(), ms = now.getMilliseconds();
        
        document.getElementById('hourHand').setAttribute('transform', `rotate(${h%12*30 + m/2 + s/120},140,140)`);
        document.getElementById('minHand').setAttribute('transform', `rotate(${m*6 + s/10},140,140)`);
        document.getElementById('secHand').setAttribute('transform', `rotate(${s*6 + ms/1000*6},140,140)`);

        let h12 = h%12||12;
        let ampm = h>=12?'PM':'AM';
        let timeString = settings.hourFormat === '24' ? `${fmt2(h)}:${fmt2(m)}` : `${fmt2(h12)}:${fmt2(m)} ${ampm}`;
        
        document.getElementById('digitalTime').innerText = timeString;
        document.getElementById('digitalSeconds').innerHTML = `:${fmt2(s)} SEC`;
        document.getElementById('headerTime').innerText = timeString;

        const weekdays = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
        const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
        document.getElementById('digitalDate').innerText = `${weekdays[now.getDay()]} ${now.getDate()} ${months[now.getMonth()]}`;

        let totalMins = h*60+m;
        let ring = document.getElementById('dayRing');
        if(ring) ring.setAttribute('stroke-dashoffset', 125.6*(1-totalMins/1440));

        document.querySelectorAll('.city-time').forEach(el => {
          let off = parseInt(el.dataset.off);
          let t = new Date(now.getTime() + now.getTimezoneOffset()*60000 + off*3600000);
          let hh = t.getHours(), mm = t.getMinutes();
          el.innerText = settings.hourFormat === '24' ? `${fmt2(hh)}:${fmt2(mm)}` : `${fmt2(hh%12||12)}:${fmt2(mm)} ${hh>=12?'PM':'AM'}`;
        });

        // Waveform
        let bars = document.querySelectorAll('.wave-bar');
        if(bars.length===0) {
          let wf = document.getElementById('waveform');
          for(let i=0;i<13;i++) { 
            let d = document.createElement('div'); 
            d.className='wave-bar'; 
            wf.appendChild(d); 
          }
          bars = document.querySelectorAll('.wave-bar');
        }
        bars.forEach((b,i)=> { 
          b.style.height = (6 + Math.abs(Math.sin(Date.now()/150 + i))*25) + 'px';
        });

        checkAlarms(now);
      }
      setInterval(updateClock, 50);
      updateClock();

      // Stopwatch
      let swRun=false, swStart=0, swElapsed=0, swInt, laps=[];
      const swDisp = document.getElementById('swDisp');
      document.getElementById('swStart').onclick = ()=>{
        if(!swRun) {
          swStart = Date.now() - swElapsed;
          swInt = setInterval(()=>{ 
            let t=Date.now()-swStart; 
            let min=Math.floor(t/60000)%60, sec=Math.floor(t/1000)%60, ms=t%1000; 
            swDisp.innerHTML = `${fmt2(min)}:${fmt2(sec)}<span class="sw-ms">.${fmt3(ms)}</span>`; 
          }, 10);
          swRun=true; 
          document.getElementById('swStart').innerHTML = 'PAUSE';
          showToast('Stopwatch started');
        } else { 
          clearInterval(swInt); 
          swElapsed = Date.now()-swStart; 
          swRun=false; 
          document.getElementById('swStart').innerHTML = 'RESUME';
          showToast('Stopwatch paused');
        }
      };
      document.getElementById('swReset').onclick = ()=>{
        clearInterval(swInt); 
        swRun=false; 
        swElapsed=0; 
        laps=[];
        swDisp.innerHTML = '00:00<span class="sw-ms">.000</span>';
        document.getElementById('lapsList').innerHTML = '';
        document.getElementById('swStart').innerHTML = 'START';
        showToast('Stopwatch reset');
      };
      document.getElementById('swLap').onclick = ()=>{
        if(!swRun) {
          showToast('Start stopwatch first');
          return;
        }
        let total = Date.now()-swStart;
        laps.push(total);
        let list = document.getElementById('lapsList');
        list.innerHTML = laps.slice(-5).map((lap,i)=> `<div class="lap-item"><span>Lap ${i+1}</span><span>${fmt2(Math.floor(lap/60000)%60)}:${fmt2(Math.floor(lap/1000)%60)}.${fmt3(lap%1000)}</span></div>`).join('');
        showToast(`Lap ${laps.length} recorded`);
      };

      // Timer with background support
      let timerRun=false, timerRemain=0, timerTotal=0, timerInt, backgroundTimerId;
      const tH=document.getElementById('tH'), tM=document.getElementById('tM'), tS=document.getElementById('tS');
      const timerDisp = document.getElementById('timerDisp');
      const timerInputs = document.getElementById('timerInputs');
      const timerStartBtn = document.getElementById('timerStart');
      
      document.getElementById('timerStart').onclick = ()=>{
        if(!timerRun) {
          let h=+tH.value||0, m=+tM.value||0, s=+tS.value||0; 
          let total = h*3600+m*60+s;
          if(total<=0) {
            showToast('Set a valid time');
            return;
          }
          if(timerRemain===0) timerTotal=total, timerRemain=total;
          
          // Start background timer if page is hidden
          if (document.hidden) {
            backgroundTimerId = startBackgroundTimer(total / 60);
          } else {
            timerInt = setInterval(()=>{
              if(timerRemain<=0){
                clearInterval(timerInt); 
                timerRun=false; 
                timerStartBtn.innerHTML = 'START';
                timerDisp.classList.remove('visible'); 
                timerInputs.classList.remove('hidden');
                playSoundInBackground(settings.defaultTune);
                showToast('Timer finished!');
                return; 
              }
              timerRemain--; 
              let hh=Math.floor(timerRemain/3600), mm=Math.floor((timerRemain%3600)/60), ss=timerRemain%60;
              timerDisp.innerText = `${fmt2(hh)}:${fmt2(mm)}:${fmt2(ss)}`;
            },1000);
          }
          
          timerRun=true; 
          timerStartBtn.innerHTML = 'PAUSE';
          timerInputs.classList.add('hidden');
          timerDisp.classList.add('visible');
          showToast('Timer started');
        } else { 
          clearInterval(timerInt); 
          clearTimeout(backgroundTimerId);
          timerRun=false; 
          timerStartBtn.innerHTML = 'RESUME';
          showToast('Timer paused');
        }
      };
      
      document.getElementById('timerReset').onclick = ()=>{
        clearInterval(timerInt); 
        clearTimeout(backgroundTimerId);
        timerRun=false; 
        timerRemain=0;
        timerInputs.classList.remove('hidden');
        timerDisp.classList.remove('visible');
        timerStartBtn.innerHTML = 'START';
        showToast('Timer reset');
      };

      // ========== ALARM FUNCTIONS ==========
      function saveAlarms() { 
        localStorage.setItem('choroid_alarms_v2', JSON.stringify(alarms)); 
        renderAlarms(); 
        
        // Sync with service worker if available
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: 'SYNC_ALARMS',
            alarms: alarms
          });
        }
      }

      function renderAlarms() {
        let grid = document.getElementById('alarmsGrid');
        if(!grid) return;
        if(alarms.length===0) { 
          grid.innerHTML = '<div style="padding:50px; text-align:center; color:var(--md-sys-color-on-surface-variant);">‚è∞ No alarms set</div>'; 
          return; 
        }
        grid.innerHTML = alarms.map(a => `<div class="alarm-card" data-id="${a.id}">
          <div class="alarm-row">
            <span class="alarm-time">${a.time} <span class="alarm-ampm">${a.ampm}</span></span>
            <label class="toggle">
              <input type="checkbox" ${a.active?'checked':''} class="alarmToggle" data-id="${a.id}">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div style="margin:12px 0; display:flex; align-items:center; gap:8px;">
            <span class="material-symbols-outlined" style="font-size:1.2rem; color:var(--md-gold);">label</span>
            ${a.label || 'Alarm'}
          </div>
          <div style="margin:12px 0; display:flex; gap:6px; flex-wrap:wrap;">
            ${a.days && a.days.length ? a.days.map(d => `<span style="background:var(--md-sys-color-surface-variant); padding:6px 14px; border-radius:40px; font-size:0.8rem;">${d}</span>`).join('') : '<span style="background:var(--md-sys-color-surface-variant); padding:6px 14px; border-radius:40px; font-size:0.8rem;">Once</span>'}
          </div>
          <div style="display:flex; gap:10px; margin-top:16px;">
            <button class="btn editBtn" data-id="${a.id}">EDIT</button>
            <button class="btn danger delBtn" data-id="${a.id}">DELETE</button>
          </div>
        </div>`).join('');

        // Toggle
        document.querySelectorAll('.alarmToggle').forEach(cb => {
          cb.addEventListener('change', function(e) {
            e.stopPropagation();
            let id = Number(this.dataset.id);
            let alarm = alarms.find(x => x.id === id);
            if(alarm) { 
              alarm.active = this.checked; 
              saveAlarms(); 
              showToast(alarm.active ? 'Alarm enabled' : 'Alarm disabled');
            }
          });
        });

        // Delete
        document.querySelectorAll('.delBtn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            let id = Number(btn.dataset.id);
            alarms = alarms.filter(x => x.id !== id);
            saveAlarms();
            showToast('Alarm deleted');
          });
        });

        // Edit
        document.querySelectorAll('.editBtn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            let id = Number(btn.dataset.id);
            let alarm = alarms.find(x => x.id === id);
            if(!alarm) return;
            editingId = id;
            document.getElementById('modalTitle').innerText = 'Edit alarm';
            let [h, m] = alarm.time.split(':').map(Number);
            document.getElementById('modalH').value = h;
            document.getElementById('modalM').value = m;
            currentAmPm = alarm.ampm;
            document.getElementById('modalAm').classList.toggle('active', alarm.ampm === 'AM');
            document.getElementById('modalPm').classList.toggle('active', alarm.ampm === 'PM');
            document.getElementById('modalLabel').value = alarm.label || '';
            
            document.querySelectorAll('#daySelectorContainer .day-btn').forEach(b => b.classList.remove('active'));
            if(alarm.days) {
              alarm.days.forEach(d => {
                let btn = Array.from(document.querySelectorAll('#daySelectorContainer .day-btn')).find(b => b.innerText === d);
                if(btn) btn.classList.add('active');
              });
            }
            document.getElementById('alarmSoundSelect').value = alarm.sound || 'classic';
            document.getElementById('alarmModal').classList.add('open');
          });
        });
      }

      // Alarm modal
      const alarmModal = document.getElementById('alarmModal');
      let currentAmPm = 'AM';

      // Day selector
      const dayContainer = document.getElementById('daySelectorContainer');
      dayContainer.innerHTML = '';
      DAYS.forEach(d => {
        let btn = document.createElement('button');
        btn.className = 'btn day-btn';
        btn.innerText = d;
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          this.classList.toggle('active');
        });
        dayContainer.appendChild(btn);
      });

      document.getElementById('modalAm').addEventListener('click', function() {
        currentAmPm = 'AM';
        document.getElementById('modalAm').classList.add('active');
        document.getElementById('modalPm').classList.remove('active');
      });
      document.getElementById('modalPm').addEventListener('click', function() {
        currentAmPm = 'PM';
        document.getElementById('modalPm').classList.add('active');
        document.getElementById('modalAm').classList.remove('active');
      });
      document.getElementById('modalAm').classList.add('active');

      // Open modal
      document.getElementById('openModalBtn').addEventListener('click', ()=>{
        editingId = null;
        document.getElementById('modalTitle').innerText = 'New alarm';
        document.getElementById('modalH').value = '7';
        document.getElementById('modalM').value = '0';
        currentAmPm = 'AM';
        document.getElementById('modalAm').classList.add('active');
        document.getElementById('modalPm').classList.remove('active');
        document.getElementById('modalLabel').value = '';
        
        document.querySelectorAll('#daySelectorContainer .day-btn').forEach(b => b.classList.remove('active'));
        ['MON','TUE','WED','THU','FRI'].forEach(d => {
          let btn = Array.from(document.querySelectorAll('#daySelectorContainer .day-btn')).find(b => b.innerText === d);
          if(btn) btn.classList.add('active');
        });
        document.getElementById('alarmSoundSelect').value = settings.defaultTune || 'classic';
        alarmModal.classList.add('open');
      });

      document.getElementById('cancelModal').addEventListener('click', ()=> {
        alarmModal.classList.remove('open');
      });

      document.getElementById('saveAlarm').onclick = ()=>{
        let h = document.getElementById('modalH').value || 7;
        let m = document.getElementById('modalM').value || 0;
        if(h>12) h=12; 
        if(m>59) m=59;
        let time = `${fmt2(h)}:${fmt2(m)}`;
        let label = document.getElementById('modalLabel').value || 'Alarm';
        let days = Array.from(document.querySelectorAll('#daySelectorContainer .day-btn.active')).map(b=>b.innerText);
        let sound = document.getElementById('alarmSoundSelect').value;

        if(editingId) {
          let idx = alarms.findIndex(x => x.id === editingId);
          if(idx !== -1) {
            alarms[idx] = { ...alarms[idx], time, ampm: currentAmPm, label, days, sound };
          }
        } else {
          let newAlarm = { id: Date.now(), time, ampm: currentAmPm, label, days, sound, active: true };
          alarms.push(newAlarm);
        }
        saveAlarms();
        alarmModal.classList.remove('open');
        showToast('Alarm saved');
      };

      // Settings modal
      const settingsModal = document.getElementById('settingsModal');
      document.getElementById('settingsBtn').addEventListener('click', ()=>{
        document.getElementById('themeSelect').value = settings.theme;
        document.getElementById('defaultViewSelect').value = settings.defaultView;
        document.getElementById('timerAutoStart').value = settings.timerAutoStart;
        document.getElementById('vibrationSelect').value = settings.vibration;
        document.getElementById('hourFormat').value = settings.hourFormat;
        document.getElementById('defaultAlarmTune').value = settings.defaultTune || 'classic';
        settingsModal.classList.add('open');
      });

      document.getElementById('closeSettings').addEventListener('click', ()=> settingsModal.classList.remove('open'));

      // Upload tune
      document.getElementById('uploadTune').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            settings.uploadedTune = ev.target.result;
            settings.uploadedTuneName = file.name;
            localStorage.setItem('choroid_settings_v2', JSON.stringify(settings));
            showToast(`‚úÖ Uploaded: ${file.name}`);
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById('saveSettings').addEventListener('click', ()=>{
        settings = {
          ...settings,
          theme: document.getElementById('themeSelect').value,
          defaultView: document.getElementById('defaultViewSelect').value,
          timerAutoStart: document.getElementById('timerAutoStart').value,
          vibration: document.getElementById('vibrationSelect').value,
          hourFormat: document.getElementById('hourFormat').value,
          defaultTune: document.getElementById('defaultAlarmTune').value,
        };
        localStorage.setItem('choroid_settings_v2', JSON.stringify(settings));
        
        if(settings.theme === 'light') {
          document.body.classList.add('light-theme');
        } else {
          document.body.classList.remove('light-theme');
        }
        
        showToast('Settings saved');
        settingsModal.classList.remove('open');
        updateClock();
      });

      // Toast
      function showToast(msg) {
        let t = document.getElementById('toast');
        t.innerHTML = `<div class="toast show">${msg}</div>`;
        setTimeout(()=>{ 
          let toast = t.querySelector('.toast');
          if(toast) {
            toast.classList.remove('show');
            setTimeout(() => t.innerHTML = '', 300);
          }
        }, 2500);
      }

      // Initial render
      renderAlarms();

      // Apply default view
      if(settings.defaultView === 'alarm') {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelector('[data-view="alarm"]').classList.add('active');
        document.getElementById('view-clock').classList.remove('active');
        document.getElementById('view-alarm').classList.add('active');
      }

      // View switch
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          let v = btn.dataset.view;
          document.querySelectorAll('.view').forEach(vv=>vv.classList.remove('active'));
          document.getElementById('view-'+v).classList.add('active');
        });
      });

      // Welcome message
      setTimeout(() => {
        showToast('Choroid');
      }, 500);
    })();
  </script>
</body>
</html>
